<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Académie de Piano - Accueil</title>
    <link href="https://fonts.googleapis.com/css?family=Gochi+Hand|Arvo:400,700" rel="stylesheet">
    <link href="css/jquery.bxslider.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <script src="css/sweetalert2.min.js"></script>
    <style>
        .table {
            width: 100%;
            border-radius: 4px;
        }

        .tr,
        .th,
        .td {
            border: 1px solid rgb(117, 117, 117);
            text-align: center;
            padding: 1%;
        }
    </style>
</head>

<body>
    <div id="wrapper" class="gallery">
        <div class="wrapper-holder">
            <header id="header">
                <div class="left-part"></div>
                <a id="logo" href="index.html">KidZik</a>
                <div class="bar-holder">
                    <a class="menu_trigger" href="#">Menu</a>
                    <nav id="nav">
                        <ul>
                            <li><a href="index.html">Accueil</a></li>
                            <li><a href="cours.html">Cours</a></li>
                            <li><a href="parametre.html">Paramètres</a></li>
                        </ul>
                    </nav>
                </div>
            </header>
            <div class="dvdr"></div>
            <div class="container">
                <section id="main">
                    <h1 style="text-align: center;">Paramètres</h1>
                    <div class="tabs">
                        <ul class="filter-controls">
                            <li><a href="#" onclick="showSection('avatar-section')">Avatar</a></li>
                            <li><a href="#" onclick="showSection('profil-section')">Profil</a></li>
                            <li><a href="#" onclick="showSection('progressions-section')">Progressions</a></li>
                        </ul>
                    </div>
                    <ul style="height: 60vh;">
                        <li class="section-content active" id="avatar-section">
                            <br><br>
                            <ul class="slider sortable-grid">
                                <li>
                                    <ul>
                                        <li class="grid-item meeting"
                                            onclick="selectAvatar('images/img-meeting01.jpg')">
                                            <a href="#"><img src="images/img-meeting01.jpg" alt="" />
                                                <div class="mask"></div>
                                            </a>
                                        </li>
                                        <li class="grid-item meeting"
                                            onclick="selectAvatar('images/img-meeting02.jpg')">
                                            <a href="#"><img src="images/img-meeting02.jpg" alt="" />
                                                <div class="mask"></div>
                                            </a>
                                        </li>
                                        <li class="grid-item meeting"
                                            onclick="selectAvatar('images/img-meeting03.jpg')">
                                            <a href="#"><img src="images/img-meeting03.jpg" alt="" />
                                                <div class="mask"></div>
                                            </a>
                                        </li>
                                        <li class="grid-item meeting"
                                            onclick="selectAvatar('images/img-meeting04.jpg')">
                                            <a href="#"><img src="images/img-meeting04.jpg" alt="" />
                                                <div class="mask"></div>
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li class="section-content" id="profil-section">
                            <br><br>
                            <form id="profile-form" onsubmit="saveProfile(event)">
                                <input type="text" id="nom" name="nom" required><br><br>
                                <input type="text" id="prenom" name="prenom" required><br><br>
                                <input type="date" id="dateNaissance" name="dateNaissance" required><br><br>
                                <button class="btn yellow" href="#" type="submit">Enregistrer</button>
                            </form>
                        </li>
                        <li class="section-content" id="progressions-section">
                            <br><br>
                            <table border="1" class="table">
                                <thead>
                                    <tr class="tr">
                                        <th class="th"><b>Nom</b></th>
                                        <th class="th"><b>Prénom</b></th>
                                        <th class="th"><b>Date de Naissance</b></th>
                                    </tr>
                                    <tr class="tr">
                                        <th class="th"><span id="nomUser"></span></th>
                                        <th class="th"><span id="prenomUser"></span></th>
                                        <th class="th"><span id="dateNaissanceUser"></span></th>
                                    </tr>
                                    <tr class="tr">
                                        <th class="th">Apprentissage</th>
                                        <th class="th">Jeux</th>
                                        <th class="th">Quiz</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="tr">
                                        <td class="td">
                                            <span id="apprentissage-stat"></span>
                                        </td>
                                        <td class="td">
                                            <span id="jeu-stat"></span>
                                        </td>
                                        <td class="td">
                                            <span id="quiz-stat"></span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </li>
                    </ul>
                </section>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="js/jquery.bxslider.min.js"></script>
    <script type="text/javascript" src="js/jquery.placeholder.js"></script>
    <script type="text/javascript" src="js/imagesloaded.pkgd.min.js"></script>
    <script type="text/javascript" src="js/isotope.pkgd.min.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script>
        let storedNom;
        let storedPrenom;
        let storedDateNaissance;
        let storedPerformances;
        let storedgamesHistory;
        let storedquizSessions;
        let gamesPourcent;
        let successRatioPerf = 0;
        let successRatioGame = 0;
        let successRatioQuiz = 0;

        $(document).ready(function () {
            fetchProfile();
        });

        function fetchProfile() {
            storedNom = localStorage.getItem('nom') || '--------';
            storedPrenom = localStorage.getItem('prenom') || '--------';
            storedDateNaissance = localStorage.getItem('dateNaissance') || '--------';
            storedPerformances = JSON.parse(localStorage.getItem('performance')) || [];
            storedGamesHistory = JSON.parse(localStorage.getItem('gamesHistory')) || [];
            storedQuizSessions = JSON.parse(localStorage.getItem('quizSessions')) || [];

            if (storedPerformances !== null && storedPerformances.length > 0) {
                let successCount = storedPerformances.filter(item => item.success === true).length;
                let totalCount = storedPerformances.length;
                successRatioPerf = (successCount / totalCount) * 100;
            }

            if (storedQuizSessions !== null && storedQuizSessions.length > 0) {
                let successCount = storedQuizSessions.filter(item => item.correct != "Non").length;
                let totalCount = storedPerformances.length;
                successRatioQuiz = (successCount / totalCount) * 100;
            }

            let totalGames = storedGamesHistory.length;
            let totalProgress = 0;

            storedGamesHistory.forEach(game => {
                let totalAttempts = game.correctAttempts + game.wrongAttempts;
                let percentageProgress = (game.correctAttempts / totalAttempts) * 100;
                totalProgress += percentageProgress;
            });

            // Calcul du pourcentage global
            let globalPercentage = totalProgress / totalGames;
            successRatioGame = globalPercentage
            console.log(`Ratio de succès : ${successRatioGame.toFixed(2)}%`);
            $('#nomUser').text(storedNom);
            $('#prenomUser').text(storedPrenom);
            $('#dateNaissanceUser').text(storedDateNaissance);
            $('#nom').val(storedNom);
            $('#prenom').val(storedPrenom);
            $('#dateNaissance').val(storedDateNaissance);

            $("#apprentissage-stat").text(successRatioPerf.toFixed(2)+"%");
            $("#jeu-stat").text(successRatioGame.toFixed(2)+"%");
            $("#quiz-stat").text(successRatioQuiz.toFixed(2)+"%");
        }

        function showSection(sectionId) {
            $('.section-content').removeClass('active');
            $('#' + sectionId).addClass('active');
        }

        function selectAvatar(avatarName) {
            Swal.fire({
                title: 'Confirmer la sélection',
                text: `Sélectionner cette image comme votre avatar ?`,
                showCancelButton: true,
                confirmButtonText: 'Continuer',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.setItem('avatar', avatarName);
                    Swal.fire({
                        title: 'Sélectionné!',
                        text: `Image sélectionnée comme votre nouvel avatar.`,
                        confirmButtonText: 'Continuer'
                    });
                }
            });
        }

        function saveProfile(event) {
            event.preventDefault();
            const nom = $('#nom').val();
            const prenom = $('#prenom').val();
            const dateNaissance = $('#dateNaissance').val();

            Swal.fire({
                title: 'Confirmer Enregistrement',
                text: "Souhaitez-vous continuer vers l'enregistrement de ces informations ?",
                showCancelButton: true,
                confirmButtonText: 'Continuer',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.setItem('nom', nom);
                    localStorage.setItem('prenom', prenom);
                    localStorage.setItem('dateNaissance', dateNaissance);

                    Swal.fire({
                        title: 'Profil enregistré !',
                        text: "Votre profil utilisateur a été enregistré avec succès.",
                        confirmButtonText: 'Continuer'
                    });
                    $('#nom').val(nom);
                    $('#prenom').val(prenom);
                    $('#dateNaissance').val(dateNaissance);
                    $('#nomUser').text(nom);
                    $('#prenomUser').text(prenom);
                    $('#dateNaissanceUser').text(dateNaissance);

                }
            });
        }
    </script>
</body>

</html>